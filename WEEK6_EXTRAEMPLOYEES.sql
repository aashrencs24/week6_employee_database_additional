CREATE DATABASE EMPDATA;
USE EMPDATA;

CREATE TABLE DEPT (
    DEPTNO INT PRIMARY KEY,
    DNAME VARCHAR(50),
    DLOC VARCHAR(50)
);

CREATE TABLE EMPLOYEE (
    EMPNO INT PRIMARY KEY,
    ENAME VARCHAR(50),
    MGR_NO INT,
    HIREDATE DATE,
    SAL FLOAT,
    DEPTNO INT,
    FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO),
    FOREIGN KEY (MGR_NO) REFERENCES EMPLOYEE(EMPNO)
);

CREATE TABLE PROJECT (
    PNO INT PRIMARY KEY,
    PLOC VARCHAR(50),
    PNAME VARCHAR(50)
);

CREATE TABLE ASSIGNED_TO (
    EMPNO INT,
    PNO INT,
    JOB_ROLE VARCHAR(50),
    PRIMARY KEY (EMPNO, PNO),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
    EMPNO INT,
    INCENTIVE_DATE DATE,
    INCENTIVE_AMOUNT FLOAT,
    PRIMARY KEY (EMPNO, INCENTIVE_DATE),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);



INSERT INTO DEPT VALUES (101, 'Sales', 'Mumbai');
INSERT INTO DEPT VALUES (102, 'IT', 'Bangalore');
INSERT INTO DEPT VALUES (103, 'HR', 'Delhi');
INSERT INTO DEPT VALUES (104, 'Finance', 'Chennai');
INSERT INTO DEPT VALUES (105, 'Marketing', 'Hyderabad');
INSERT INTO DEPT VALUES (106, 'Production', 'Pune');


INSERT INTO EMPLOYEE VALUES (1, 'Anita', NULL, '2017-02-10', 90000, 101);
INSERT INTO EMPLOYEE VALUES (2, 'Rohan', 1, '2018-06-18', 65000, 101);
INSERT INTO EMPLOYEE VALUES (3, 'Priya', 1, '2020-05-21', 55000, 101);
INSERT INTO EMPLOYEE VALUES (4, 'Arjun', NULL, '2016-03-15', 95000, 102);
INSERT INTO EMPLOYEE VALUES (5, 'Kavita', 4, '2019-08-11', 40000, 102);
INSERT INTO EMPLOYEE VALUES (6, 'Neha', 4, '2021-09-10', 35000, 102);
INSERT INTO EMPLOYEE VALUES (7, 'Raj', NULL, '2015-10-01', 85000, 103);
INSERT INTO EMPLOYEE VALUES (8, 'Farhan', 7, '2018-12-12', 48000, 103);
INSERT INTO EMPLOYEE VALUES (9, 'Tina', 7, '2022-01-25', 42000, 103);
INSERT INTO EMPLOYEE VALUES (10, 'Suresh', NULL, '2013-07-22', 92000, 104);
INSERT INTO EMPLOYEE VALUES (11, 'Jaya', 10, '2019-04-03', 74000, 104);
INSERT INTO EMPLOYEE VALUES (12, 'Mohan', NULL, '2014-11-19', 91000, 105);


INSERT INTO PROJECT VALUES (201, 'Mumbai', 'CRM Implementation');
INSERT INTO PROJECT VALUES (202, 'Bangalore', 'Website Redesign');
INSERT INTO PROJECT VALUES (203, 'Delhi', 'Recruitment Drive');
INSERT INTO PROJECT VALUES (204, 'Chennai', 'Audit Preparation');
INSERT INTO PROJECT VALUES (205, 'Hyderabad', 'Ad Campaign');
INSERT INTO PROJECT VALUES (206, 'Pune', 'Quality Improvement');

INSERT INTO ASSIGNED_TO VALUES (2, 201, 'Developer');
INSERT INTO ASSIGNED_TO VALUES (3, 201, 'Tester');
INSERT INTO ASSIGNED_TO VALUES (5, 202, 'Designer');
INSERT INTO ASSIGNED_TO VALUES (6, 202, 'Developer');
INSERT INTO ASSIGNED_TO VALUES (8, 203, 'HR Executive');
INSERT INTO ASSIGNED_TO VALUES (9, 203, 'Recruiter');
INSERT INTO ASSIGNED_TO VALUES (11, 204, 'Finance Analyst');
INSERT INTO ASSIGNED_TO VALUES (7, 203, 'Manager');
INSERT INTO ASSIGNED_TO VALUES (12, 205, 'Marketing Lead');
INSERT INTO ASSIGNED_TO VALUES (10, 204, 'Finance Manager');


INSERT INTO INCENTIVES VALUES (2, '2019-01-05', 10000);
INSERT INTO INCENTIVES VALUES (3, '2019-01-10', 7000);
INSERT INTO INCENTIVES VALUES (5, '2019-01-15', 9500);
INSERT INTO INCENTIVES VALUES (6, '2019-01-22', 8000);
INSERT INTO INCENTIVES VALUES (8, '2019-01-28', 9000);
INSERT INTO INCENTIVES VALUES (9, '2019-01-29', 12000);
INSERT INTO INCENTIVES VALUES (11, '2019-01-26', 8000);
INSERT INTO INCENTIVES VALUES (12, '2019-02-10', 11000);
INSERT INTO INCENTIVES VALUES (3, '2019-02-15', 7500);

SELECT F.ENAME AS ManagerName, COUNT(*) AS NumEmployees
FROM EMPLOYEE E
JOIN EMPLOYEE F ON E.MGR_NO = F.EMPNO
GROUP BY F.ENAME
HAVING COUNT(*) = (
    SELECT MAX(NumEmployees)
    FROM (
        SELECT COUNT(*) AS NumEmployees
        FROM EMPLOYEE
        WHERE MGR_NO IS NOT NULL
        GROUP BY MGR_NO
    ) AS Sub
);

SELECT MGR_NO, COUNT(*) as NumEmployees
FROM EMPLOYEE
WHERE MGR_NO IS NOT NULL
GROUP BY MGR_NO
ORDER BY NumEmployees DESC;



SELECT E2.ENAME
FROM EMPLOYEE E2
WHERE E2.EMPNO = (
    SELECT MGR_NO
    FROM EMPLOYEE
    WHERE MGR_NO IS NOT NULL
    GROUP BY MGR_NO
    ORDER BY COUNT(*) DESC
    LIMIT 1
);


SELECT M.ENAME
FROM EMPLOYEE M
WHERE M.EMPNO IN (
    SELECT MGR_NO
    FROM EMPLOYEE
    GROUP BY MGR_NO
    HAVING M.SAL > AVG(SAL)
);


SELECT DEPTNO, ENAME
FROM (
    SELECT DEPTNO, MGR_NO, RANK() OVER (PARTITION BY DEPTNO ORDER BY SAL DESC) as rnk, ENAME
    FROM EMPLOYEE
    WHERE MGR_NO IS NOT NULL
) ranked_mgrs
WHERE rnk = 2;


SELECT *
FROM INCENTIVES
WHERE INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
ORDER BY INCENTIVE_AMOUNT DESC
LIMIT 1 OFFSET 1;


SELECT E.ENAME
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
WHERE E.DEPTNO = M.DEPTNO;